<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>标记重捕法模拟实验 - 绵羊种群数量估算</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#4ade80',
                        accent: '#f97316',
                        neutral: '#f1f5f9',
                        dark: '#1e293b'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .sheep-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(25px, 1fr));
                gap: 3px;
            }
            .sheep-item {
                transition: all 0.3s ease;
                width: 5px !important;
                height: 5px !important;
            }
            .sheep-item.marked {
                background-color: #f97316;
                border-color: #ea580c;
            }
            .sheep-item.captured {
                transform: scale(0.9);
                box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            }
            .stat-card {
                backdrop-filter: blur(8px);
                background-color: rgba(255, 255, 255, 0.8);
            }
        }
        /* 防遮挡核心样式 */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            overflow-x: hidden;
            min-height: 100vh;
        }
        .main-container {
            display: grid;
            grid-template-rows: auto auto;
            gap: 1.5rem;
            padding-bottom: 2rem;
        }
        .top-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 1rem;
        }
        .bottom-row {
            display: grid;
            grid-template-columns: 2fr 3fr;
            gap: 1rem;
        }
        @media (max-width: 1023px) {
            .top-row {
                grid-template-columns: 1fr 1fr;
            }
            .bottom-row {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 639px) {
            .top-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="bg-neutral font-sans text-dark">
    <!-- 顶部导航栏 -->
    <header class="bg-primary text-white shadow-lg py-3">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div class="flex items-center">
                <i class="fa fa-paw text-2xl mr-2"></i>
                <h1 class="text-xl font-bold">标记重捕法模拟实验</h1>
            </div>
            <div class="text-xs">
                <span class="font-semibold">实际绵羊总数(N):</span>
                <span class="bg-white/20 px-2 py-1 rounded">268只</span>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 py-5 main-container">
        <!-- 第一排：实验设置、重捕记录、累计统计、估算结果 -->
        <div class="top-row">
            <!-- 实验设置区 -->
            <section class="bg-white rounded-xl shadow-md p-4 h-full">
                <h2 class="text-lg font-bold mb-2 flex items-center">
                    <i class="fa fa-cog text-primary mr-2"></i>实验设置
                </h2>
                <div class="space-y-2">
                    <!-- 初次标记设置 -->
                    <div class="bg-neutral/50 rounded-lg p-2">
                        <label class="block font-semibold mb-1 text-sm">初次捕获并标记数量(M):</label>
                        <div class="flex items-center">
                            <input 
                                type="number" 
                                id="markedCount" 
                                min="10" 
                                max="150" 
                                value="50" 
                                class="w-full px-2 py-1 border border-gray-300 rounded-l focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-sm"
                            >
                            <button 
                                id="setupMarkedCount" 
                                class="bg-primary text-white px-3 py-1 rounded-r hover:bg-primary/90 transition-colors text-sm"
                            >
                                <i class="fa fa-check mr-1"></i>设置
                            </button>
                        </div>
                        <p class="text-xs text-gray-600 mt-1">范围: 10-150只</p>
                    </div>

                    <!-- 重捕设置 -->
                    <div class="bg-neutral/50 rounded-lg p-2">
                        <label class="block font-semibold mb-1 text-sm">单次重捕数量:</label>
                        <div class="flex items-center">
                            <input 
                                type="number" 
                                id="recaptureCount" 
                                min="5" 
                                max="80" 
                                value="30" 
                                class="w-full px-2 py-1 border border-gray-300 rounded-l focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-sm"
                            >
                            <button 
                                id="setupRecaptureCount" 
                                class="bg-primary text-white px-3 py-1 rounded-r hover:bg-primary/90 transition-colors text-sm"
                            >
                                <i class="fa fa-check mr-1"></i>设置
                            </button>
                        </div>
                        <p class="text-xs text-gray-600 mt-1">范围: 5-80只</p>
                    </div>

                    <!-- 重捕操作 -->
                    <div class="bg-neutral/50 rounded-lg p-2 flex flex-col gap-1">
                        <label class="block font-semibold mb-1 text-sm">重捕操作:</label>
                        <div class="flex gap-2">
                            <button 
                                id="recaptureOnce" 
                                class="bg-secondary text-dark flex-1 px-2 py-1 rounded hover:bg-secondary/90 transition-colors text-sm"
                            >
                                <i class="fa fa-search mr-1"></i>单次重捕
                            </button>
                            <button 
                                id="clearAllData" 
                                class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 transition-colors text-sm"
                            >
                                <i class="fa fa-refresh mr-1"></i>重置
                            </button>
                        </div>
                        <button 
                            id="autoRecapture" 
                            class="bg-accent text-white px-2 py-1 rounded hover:bg-accent/90 transition-colors text-sm mt-1"
                        >
                            <i class="fa fa-play mr-1"></i>自动重捕10次
                        </button>
                    </div>
                </div>
            </section>

            <!-- 重捕记录 -->
            <div class="stat-card rounded-xl shadow-md p-4 h-full">
                <h3 class="text-lg font-bold mb-2 flex items-center">
                    <i class="fa fa-list text-primary mr-2"></i>重捕记录
                </h3>
                <div class="max-h-[180px] overflow-auto pr-1">
                    <table class="w-full text-xs">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left pb-1">次数</th>
                                <th class="text-left pb-1">重捕数(n)</th>
                                <th class="text-left pb-1">标记数(m)</th>
                            </tr>
                        </thead>
                        <tbody id="recaptureRecords">
                            <tr>
                                <td colspan="3" class="text-center text-gray-500 py-2">暂无重捕数据</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 累计数据统计 -->
            <div class="stat-card rounded-xl shadow-md p-4 h-full">
                <h3 class="text-lg font-bold mb-2 flex items-center">
                    <i class="fa fa-bar-chart text-primary mr-2"></i>累计统计
                </h3>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-sm">初次标记数(M):</span>
                        <span id="totalMarked" class="font-semibold text-base">--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-sm">累计重捕总数(∑n):</span>
                        <span id="totalRecaptured" class="font-semibold text-base">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-sm">累计标记重捕数(∑m):</span>
                        <span id="totalRecapturedMarked" class="font-semibold text-base">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-sm">标记个体占比:</span>
                        <span id="markedPercentage" class="font-semibold text-base">--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-sm">重捕总次数:</span>
                        <span id="totalRecaptures" class="font-semibold text-base">0</span>
                    </div>
                </div>
            </div>

            <!-- 估算结果 -->
            <div class="stat-card rounded-xl shadow-md p-4 h-full">
                <h3 class="text-lg font-bold mb-2 flex items-center">
                    <i class="fa fa-calculator text-primary mr-2"></i>估算结果
                </h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-sm">当前估算总数(N):</span>
                        <span id="estimatedTotal" class="text-xl font-bold text-primary">--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-sm">与实际值误差:</span>
                        <span id="errorValue" class="text-lg font-bold text-red-500">--</span>
                    </div>
                </div>
                <div class="mt-2 pt-2 border-t border-gray-200">
                    <p class="text-xs text-gray-600">
                        计算公式: N = (M × ∑n) / ∑m
                        <br>
                        M=初次标记数, ∑n=重捕总数, ∑m=重捕标记总数
                    </p>
                </div>
            </div>
        </div>

        <!-- 第二排：草原绵羊模拟、结果分析 -->
        <div class="bottom-row">
            <!-- 可视化模拟区 -->
            <section class="bg-white rounded-xl shadow-md p-4 h-full">
                <h2 class="text-lg font-bold mb-3 flex items-center">
                    <i class="fa fa-eye text-primary mr-2"></i>草原绵羊模拟
                </h2>
                <div class="bg-green-100 rounded-lg p-3 overflow-auto max-h-[300px]">
                    <div id="sheepSimulation" class="sheep-grid"></div>
                </div>
                <div class="mt-2 flex justify-between items-center">
                    <div class="flex gap-3">
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-gray-300 rounded-full mr-1"></div>
                            <span class="text-xs">未标记绵羊</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-accent rounded-full mr-1"></div>
                            <span class="text-xs">已标记绵羊</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-primary rounded-full mr-1 border-2 border-white"></div>
                            <span class="text-xs">本次捕获</span>
                        </div>
                    </div>
                    <div class="text-xs text-gray-600">
                        可视化仅展示部分绵羊，实际总数为268只
                    </div>
                </div>
            </section>

            <!-- 结果分析图表 -->
            <section class="bg-white rounded-xl shadow-md p-4 h-full">
                <h2 class="text-lg font-bold mb-3 flex items-center">
                    <i class="fa fa-line-chart text-primary mr-2"></i>结果分析
                </h2>
                <div class="h-[300px] w-full">
                    <canvas id="resultsChart"></canvas>
                </div>
            </section>
        </div>
    </main>

    <footer class="bg-dark text-white py-3 mt-auto">
        <div class="container mx-auto px-4 text-center">
            <p class="text-xs">标记重捕法模拟实验 &copy; 2025 | 实际绵羊总数: 268只</p>
            <p class="text-xs text-gray-400 mt-1">
                标记重捕法公式: N = (M × n) / m (单次) | N = (M × ∑n) / ∑m (多次平均)
            </p>
        </div>
    </footer>

    <script>
        // 全局变量
        const ACTUAL_TOTAL = 268; // 实际总数
        let sheepPopulation = []; // 绵羊种群数据
        let markedCount = 50; // 初次标记数量
        let recaptureCount = 30; // 单次重捕数量
        let recaptureData = []; // 重捕数据
        let totalRecaptured = 0; // 累计重捕总数
        let totalRecapturedMarked = 0; // 累计重捕标记数
        let chartInstance = null; // 图表实例
        let isMarkedSet = false; // 标记数量是否已设置
        let isRecaptureSet = false; // 重捕数量是否已设置

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化种群
            initPopulation();
            // 初始化图表
            initChart();
            // 更新UI显示
            updateUI();
            
            // 绑定事件监听
            document.getElementById('setupMarkedCount').addEventListener('click', setupMarkedCount);
            document.getElementById('setupRecaptureCount').addEventListener('click', setupRecaptureCount);
            document.getElementById('recaptureOnce').addEventListener('click', recaptureOnce);
            document.getElementById('autoRecapture').addEventListener('click', autoRecapture);
            document.getElementById('clearAllData').addEventListener('click', clearAllData);
            
            // 输入框限制
            document.getElementById('markedCount').addEventListener('change', function() {
                if (this.value < 10) this.value = 10;
                if (this.value > 150) this.value = 150;
            });
            document.getElementById('recaptureCount').addEventListener('change', function() {
                if (this.value < 5) this.value = 5;
                if (this.value > 80) this.value = 80;
            });
        });

        // 初始化绵羊种群
        function initPopulation() {
            sheepPopulation = [];
            // 创建268只绵羊，初始状态为未标记
            for (let i = 0; i < ACTUAL_TOTAL; i++) {
                sheepPopulation.push({
                    id: i,
                    marked: false,
                    captured: false
                });
            }
        }

        // 设置初次标记数量（互斥限制）
        function setupMarkedCount() {
            if (isRecaptureSet && recaptureData.length > 0) {
                alert('单次重捕数量已设置且已有重捕数据，无法修改初次标记数量！');
                return;
            }
            
            // 获取设置的标记数量
            markedCount = parseInt(document.getElementById('markedCount').value);
            markedCount = Math.max(10, Math.min(150, markedCount)); // 限制范围
            
            // 随机标记指定数量的绵羊
            initPopulation(); // 重置种群
            const markedIndices = [];
            while (markedIndices.length < markedCount) {
                const randomIndex = Math.floor(Math.random() * ACTUAL_TOTAL);
                if (!markedIndices.includes(randomIndex)) {
                    markedIndices.push(randomIndex);
                    sheepPopulation[randomIndex].marked = true;
                }
            }
            
            isMarkedSet = true;
            // 重置重捕数据（如果是修改标记数量）
            if (recaptureData.length > 0) {
                recaptureData = [];
                totalRecaptured = 0;
                totalRecapturedMarked = 0;
            }
            
            // 更新UI
            updateSimulationView();
            updateUI();
            updateChart();
            
            // 提示
            alert(`已成功设置初次标记数量为 ${markedCount} 只！`);
        }

        // 设置单次重捕数量（互斥限制）
        function setupRecaptureCount() {
            if (isMarkedSet && recaptureData.length > 0) {
                alert('初次标记数量已设置且已有重捕数据，无法修改单次重捕数量！');
                return;
            }
            
            // 获取设置的重捕数量
            recaptureCount = parseInt(document.getElementById('recaptureCount').value);
            recaptureCount = Math.max(5, Math.min(80, recaptureCount)); // 限制范围
            
            isRecaptureSet = true;
            
            // 提示
            alert(`已成功设置单次重捕数量为 ${recaptureCount} 只！`);
        }

        // 单次重捕
        function recaptureOnce() {
            // 检查是否已设置标记和重捕数量
            if (!isMarkedSet) {
                alert('请先设置初次标记数量！');
                return;
            }
            if (!isRecaptureSet) {
                alert('请先设置单次重捕数量！');
                return;
            }
            
            // 重置所有绵羊的捕获状态
            sheepPopulation.forEach(s => s.captured = false);
            
            // 随机选择重捕的绵羊
            const capturedIndices = [];
            while (capturedIndices.length < recaptureCount) {
                const randomIndex = Math.floor(Math.random() * ACTUAL_TOTAL);
                if (!capturedIndices.includes(randomIndex)) {
                    capturedIndices.push(randomIndex);
                    sheepPopulation[randomIndex].captured = true;
                }
            }
            
            // 统计本次重捕中的标记数量
            let markedInRecapture = 0;
            capturedIndices.forEach(index => {
                if (sheepPopulation[index].marked) {
                    markedInRecapture++;
                }
            });
            
            // 记录本次重捕数据
            const recaptureRecord = {
                n: recaptureCount,
                m: markedInRecapture,
                estimated: markedInRecapture > 0 ? Math.round((markedCount * recaptureCount) / markedInRecapture) : 0
            };
            
            recaptureData.push(recaptureRecord);
            totalRecaptured += recaptureCount;
            totalRecapturedMarked += markedInRecapture;
            
            // 更新UI
            updateSimulationView();
            updateUI();
            updateChart();
        }

        // 自动重捕10次
        function autoRecapture() {
            if (!isMarkedSet) {
                alert('请先设置初次标记数量！');
                return;
            }
            if (!isRecaptureSet) {
                alert('请先设置单次重捕数量！');
                return;
            }
            
            // 禁用按钮防止重复点击
            const autoBtn = document.getElementById('autoRecapture');
            autoBtn.disabled = true;
            autoBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-1"></i>正在重捕...';
            
            // 逐次重捕，间隔300ms
            let count = 0;
            const interval = setInterval(() => {
                recaptureOnce();
                count++;
                
                if (count >= 10) {
                    clearInterval(interval);
                    autoBtn.disabled = false;
                    autoBtn.innerHTML = '<i class="fa fa-play mr-1"></i>自动重捕10次';
                    alert('自动重捕完成！共完成10次重捕，可查看统计结果。');
                }
            }, 300);
        }

        // 清空所有数据
        function clearAllData() {
            initPopulation();
            recaptureData = [];
            totalRecaptured = 0;
            totalRecapturedMarked = 0;
            document.getElementById('markedCount').value = 50;
            document.getElementById('recaptureCount').value = 30;
            markedCount = 50;
            recaptureCount = 30;
            isMarkedSet = false;
            isRecaptureSet = false;
            
            updateSimulationView();
            updateUI();
            updateChart();
        }

        // 更新模拟视图
        function updateSimulationView() {
            const simulationContainer = document.getElementById('sheepSimulation');
            simulationContainer.innerHTML = '';
            
            // 显示前100只绵羊用于可视化
            const displayCount = Math.min(100, ACTUAL_TOTAL);
            
            for (let i = 0; i < displayCount; i++) {
                const sheep = sheepPopulation[i];
                const sheepElement = document.createElement('div');
                sheepElement.className = `sheep-item w-5 h-5 rounded-full border ${
                    sheep.marked ? 'marked' : 'bg-gray-300 border-gray-400'
                } ${sheep.captured ? 'captured ring-2 ring-primary' : ''}`;
                sheepElement.title = `绵羊#${i+1} | ${sheep.marked ? '已标记' : '未标记'} ${sheep.captured ? '| 本次捕获' : ''}`;
                simulationContainer.appendChild(sheepElement);
            }
        }

        // 更新UI显示
        function updateUI() {
            // 更新基本统计
            document.getElementById('totalMarked').textContent = markedCount;
            document.getElementById('totalRecaptures').textContent = recaptureData.length;
            document.getElementById('totalRecaptured').textContent = totalRecaptured;
            document.getElementById('totalRecapturedMarked').textContent = totalRecapturedMarked;
            
            // 计算标记百分比
            const markedPercentage = markedCount / ACTUAL_TOTAL * 100;
            document.getElementById('markedPercentage').textContent = `${markedPercentage.toFixed(1)}%`;
            
            // 计算估算总数
            let estimatedTotal = '--';
            let errorValue = '--';
            
            if (totalRecaptured > 0 && totalRecapturedMarked > 0) {
                estimatedTotal = Math.round((markedCount * totalRecaptured) / totalRecapturedMarked);
                const error = estimatedTotal - ACTUAL_TOTAL;
                const errorPercent = (error / ACTUAL_TOTAL) * 100;
                errorValue = `${error} (${errorPercent.toFixed(1)}%)`;
            }
            
            document.getElementById('estimatedTotal').textContent = estimatedTotal;
            document.getElementById('errorValue').textContent = errorValue;
            
            // 更新重捕记录
            const recordsTable = document.getElementById('recaptureRecords');
            if (recaptureData.length === 0) {
                recordsTable.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-2">暂无重捕数据</td></tr>';
            } else {
                let recordsHtml = '';
                recaptureData.forEach((data, index) => {
                    recordsHtml += `
                        <tr class="border-b border-gray-100 hover:bg-neutral/50">
                            <td class="py-1">${index + 1}</td>
                            <td class="py-1">${data.n}</td>
                            <td class="py-1">${data.m}</td>
                        </tr>
                    `;
                });
                recordsTable.innerHTML = recordsHtml;
            }
        }

        // 初始化图表
        function initChart() {
            const ctx = document.getElementById('resultsChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: '估算种群数量',
                            data: [],
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: '实际种群数量 (268)',
                            data: [],
                            borderColor: '#4ade80',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            tension: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '重捕次数',
                                font: { size: 12 }
                            },
                            ticks: { font: { size: 11 } }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '种群数量',
                                font: { size: 12 }
                            },
                            min: Math.max(0, ACTUAL_TOTAL - 100),
                            max: ACTUAL_TOTAL + 100,
                            ticks: { font: { size: 11 } }
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        legend: {
                            position: 'top',
                            labels: { font: { size: 11 } }
                        },
                        title: {
                            display: true,
                            text: '种群数量估算变化趋势',
                            font: { size: 13, weight: 'bold' }
                        }
                    }
                }
            });
        }

        // 更新图表
        function updateChart() {
            if (!chartInstance) return;
            
            // 准备数据
            const labels = [];
            const estimatedData = [];
            const actualData = [];
            
            // 累计计算每次的估算值
            let cumulativeN = 0;
            let cumulativeM = 0;
            
            recaptureData.forEach((data, index) => {
                labels.push(`第${index + 1}次`);
                cumulativeN += data.n;
                cumulativeM += data.m;
                
                if (cumulativeM > 0) {
                    const cumulativeEstimate = Math.round((markedCount * cumulativeN) / cumulativeM);
                    estimatedData.push(cumulativeEstimate);
                } else {
                    estimatedData.push(null);
                }
                
                actualData.push(ACTUAL_TOTAL);
            });
            
            // 更新图表数据
            chartInstance.data.labels = labels;
            chartInstance.data.datasets[0].data = estimatedData;
            chartInstance.data.datasets[1].data = actualData;
            chartInstance.update();
        }
    </script>
</body>
</html>